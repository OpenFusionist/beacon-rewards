{{template "base.html" .}}

{{define "title"}}地址收益查询 - Endurance Rewards{{end}}

{{define "content"}}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">地址收益查询</h1>
    </div>

    <form id="query-form" hx-post="/rewards/by-address" 
          hx-target="#result-container" 
          hx-swap="innerHTML"
          hx-indicator="#loading">
        <div class="form-group">
            <label for="address">地址或 Withdrawal Credentials</label>
            <input type="text" 
                   id="address" 
                   name="address" 
                   placeholder="0x..." 
                   required
                   pattern="0x[a-fA-F0-9]{40}|0x0[12][a-fA-F0-9]{62}">
            <small style="color: var(--text-secondary); display: block; margin-top: 0.25rem;">
                支持普通地址（0x + 40 字符）或 withdrawal credentials（0x01/0x02 + 64 字符）
            </small>
        </div>

        <div class="form-group">
            <label>
                <input type="checkbox" name="include_validator_indices" value="true">
                包含 Validator 索引列表
            </label>
        </div>

        <button type="submit" id="submit-btn">查询</button>
        <span id="loading" class="htmx-indicator" style="margin-left: 1rem;">加载中...</span>
    </form>
</div>

<div id="result-container"></div>

<div class="footnotes">
    <h3>字段说明</h3>
    <ol>
        <li><strong>地址</strong>：查询的存款地址或提款地址</li>
        <li><strong>活跃 Validator 数量</strong>：该地址资助的当前处于活跃状态的验证者数量</li>
        <li><strong>Validator 索引列表</strong>：该地址资助的所有活跃验证者的索引号（可选显示）</li>
        <li><strong>CL 收益</strong>：共识层收益（单位：ACE）</li>
        <li><strong>EL 收益</strong>：执行层收益（单位：ACE）</li>
        <li><strong>总收益</strong>：CL 和 EL 收益的总和（单位：ACE）</li>
        <li><strong>总有效余额</strong>：所有活跃验证者的有效余额总和（单位：ACE）</li>
        <li><strong>加权平均质押时间</strong>：基于存款金额加权的平均质押时长</li>
        <li><strong>时间窗口</strong>：当前统计的时间范围</li>
    </ol>
</div>
{{end}}

{{define "scripts"}}
<script>
    const COPY_DEFAULT_LABEL = 'Copy Address';
    const COPY_SUCCESS_LABEL = 'Copied';

    function formatGweiToAce(gwei) {
        return (gwei / 1e9).toFixed(6);
    }

    function formatNumber(num) {
        return new Intl.NumberFormat('zh-CN').format(num);
    }

    function formatTime(t) {
        return new Date(t).toLocaleString('zh-CN', {timeZone: 'UTC'}) + ' UTC';
    }

    function formatDuration(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        if (days > 0) {
            return `${days}天 ${hours}小时`;
        }
        return `${hours}小时`;
    }

    function formatAddress(addr) {
        if (!addr) return '';
        if (addr.length > 10) {
            return addr.substring(0, 6) + '...' + addr.substring(addr.length - 4);
        }
        return addr;
    }

    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target.id === 'result-container') {
            const xhr = e.detail.xhr;
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                renderResult(data);
            } else {
                renderError(xhr.responseText);
            }
        }
    });

    function renderResult(data) {
        const html = `
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h2 class="card-title">查询结果</h2>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">地址</div>
                        <div class="stat-value address address-with-copy" style="font-size: 1rem;">
                            <span>${formatAddress(data.address)}</span>
                            <button 
                                type="button"
                                class="copy-btn"
                                data-address="${data.address}"
                                aria-label="Copy Address"
                                title="Copy Address"
                                data-feedback="Copy Address">
                                <span class="sr-only">Copy Address</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                        ${data.depositor_label ? `<div style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">${data.depositor_label}</div>` : ''}
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">活跃 Validator 数量</div>
                        <div class="stat-value">${formatNumber(data.active_validator_count)}</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">CL 收益</div>
                        <div class="stat-value">${formatNumber(formatGweiToAce(data.cl_rewards_gwei))} ACE</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">EL 收益</div>
                        <div class="stat-value">${formatNumber(formatGweiToAce(data.el_rewards_gwei))} ACE</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">总收益</div>
                        <div class="stat-value">${formatNumber(formatGweiToAce(data.total_rewards_gwei))} ACE</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">总有效余额</div>
                        <div class="stat-value">${formatNumber(formatGweiToAce(data.total_effective_balance_gwei))} ACE</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">加权平均质押时间</div>
                        <div class="stat-value">${formatDuration(data.weighted_average_stake_time)}</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">时间窗口</div>
                        <div class="stat-value" style="font-size: 0.875rem;">
                            ${formatTime(data.window_start)}<br>
                            至<br>
                            ${formatTime(data.window_end)}
                        </div>
                    </div>
                </div>

                ${data.validator_indices && data.validator_indices.length > 0 ? `
                    <details style="margin-top: 1.5rem;">
                        <summary style="cursor: pointer; font-weight: 600; padding: 0.5rem; background: var(--bg-color); border-radius: 0.25rem;">
                            Validator 索引列表 (${data.validator_indices.length} 个)
                        </summary>
                        <div style="margin-top: 0.5rem; padding: 1rem; background: var(--bg-color); border-radius: 0.25rem; max-height: 300px; overflow-y: auto;">
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${data.validator_indices.map(idx => `<span class="badge badge-success">${idx}</span>`).join('')}
                            </div>
                        </div>
                    </details>
                ` : ''}
            </div>
        `;
        document.getElementById('result-container').innerHTML = html;
    }

    function renderError(responseText) {
        let errorMsg = '查询失败';
        try {
            const error = JSON.parse(responseText);
            errorMsg = error.error || errorMsg;
        } catch (e) {
            errorMsg = responseText || errorMsg;
        }
        document.getElementById('result-container').innerHTML = `
            <div class="error" style="margin-top: 1.5rem;">
                ${errorMsg}
            </div>
        `;
    }

    function showCopyFeedback(button, message) {
        button.dataset.feedback = message;
        button.classList.add('copied', 'show-feedback');
        button.setAttribute('aria-label', message);
        button.setAttribute('title', message);
        setTimeout(() => {
            button.classList.remove('copied', 'show-feedback');
            button.dataset.feedback = COPY_DEFAULT_LABEL;
            button.setAttribute('aria-label', COPY_DEFAULT_LABEL);
            button.setAttribute('title', COPY_DEFAULT_LABEL);
        }, 1600);
    }

    function copyAddress(address) {
        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            return navigator.clipboard.writeText(address);
        }
        return new Promise((resolve, reject) => {
            const textarea = document.createElement('textarea');
            textarea.value = address;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                const ok = document.execCommand('copy');
                ok ? resolve() : reject(new Error('execCommand copy failed'));
            } catch (err) {
                reject(err);
            } finally {
                document.body.removeChild(textarea);
            }
        });
    }

    // Copy button handler
    document.body.addEventListener('click', function(e) {
        const copyBtn = e.target.closest('.copy-btn');
        if (!copyBtn) {
            return;
        }
        const address = copyBtn.dataset.address;
        if (!address) {
            return;
        }
        copyAddress(address)
            .then(() => showCopyFeedback(copyBtn, COPY_SUCCESS_LABEL))
            .catch(err => {
                console.error('Failed to copy address', err);
                copyBtn.dataset.feedback = 'Copy failed';
                copyBtn.classList.add('show-feedback');
                setTimeout(() => {
                    copyBtn.classList.remove('show-feedback');
                    copyBtn.dataset.feedback = COPY_DEFAULT_LABEL;
                }, 1200);
            });
    });

    // Handle form submission with HTMX
    document.getElementById('query-form').addEventListener('submit', function(e) {
        const formData = new FormData(this);
        const address = formData.get('address');
        const includeIndices = formData.get('include_validator_indices') === 'true';
        
        htmx.ajax('POST', `/rewards/by-address${includeIndices ? '?include_validator_indices=true' : ''}`, {
            target: '#result-container',
            swap: 'innerHTML',
            values: {address: address}
        });
        
        e.preventDefault();
    });
</script>
{{end}}
